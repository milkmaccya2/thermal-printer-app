# 実装計画 - Printer Buffer Handling & Force Cut

## 目標
1. **バッファ溢れ対策 (Chunked Printing)**: 画像データを小さなチャンクに分割し、ウェイトを挟んで送信することで、プリンターのバッファ溢れを防ぐ。
2. **強制カット機能 (Force Cut)**: 印刷トラブル時に手動で用紙カットを行えるようにする。

## 変更案

### 1. サーバーサイド (`src/actions/index.ts`)
- **[NEW] `forceCut` アクション**:
    - 単純にフィードとカットコマンドのみを `lp` に送信するアクションを追加。
- **[MODIFY] `printImage` アクション**:
    - **Chunking処理**: 生成された画像データを、一定の高さ（例: 256ライン）ごとに分割する。
    - **Sequential Global Lock**: 一連の分割印刷中に他のジョブが割り込まないよう、簡易的なロック機構を導入する。
    - **Throttle**: 各チャンクの送信（`lp` 実行）間に適切なウェイト（例: 300ms〜500ms）を設ける。

### 2. UIコンポーネント
- **[MODIFY] `src/components/PrinterStatusCard.tsx`**:
    - 既存のステータス表示に加え、「✂️ Cut Paper」ボタンを追加する。
    - クリック時に `forceCut` アクションを呼び出す。

### 3. Utils (`src/utils/printer.ts`)
- **[MODIFY] `createEscPosRaster`**:
    - 分割して呼び出せるように、特段の変更は不要だが、チャンク分割ロジックを確認。
    - 現状の関数は1つのBufferを返すので、呼び出し元（Action）で画像をスライスしてから渡すのが効率的。

## 検証計画
### 動作確認
- **強制カット**: ボタンを押して、用紙がフィードされカットされることを確認。
- **長尺画像印刷**: 長い画像（Webサイトのスクショなど）を印刷し、
    - 途中で止まらずに最後まで印刷されるか。
    - 最後にカットされるか。
    - 印刷品質（つなぎ目）に問題がないか。
