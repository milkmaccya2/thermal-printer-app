---
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import { TextPrinter } from '../components/TextPrinter'
import { ImagePrinter } from '../components/ImagePrinter'
import PrinterDashboard from '../components/PrinterDashboard.astro'

let initialText = ''
let initialImage = ''

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData()

    // Check for images first
    const files = formData.getAll('files')
    if (files && files.length > 0) {
      // Assuming single file share for now, or take the first one
      const file = files[0]
      if (
        file instanceof File &&
        file.size > 0 &&
        file.type.startsWith('image/')
      ) {
        const arrayBuffer = await file.arrayBuffer()
        const base64 = Buffer.from(arrayBuffer).toString('base64')
        initialImage = `data:${file.type};base64,${base64}`
      }
    }

    // Hande text if no image or in addition to (though typically one view active)
    // If we have an image, we probably want to prioritize the ImagePrinter view
    const title = formData.get('title')?.toString() || ''
    const text = formData.get('text')?.toString() || ''
    const url = formData.get('url')?.toString() || ''

    const parts = [title, text, url].filter((p) => p && p.trim() !== '')
    initialText = parts.join('\n\n')
  } catch (error) {
    console.error('Error parsing share data:', error)
  }
}

const showImagePrinter = !!initialImage
---

<Layout title="Share to Printer">
  <div class="max-w-[1200px] mx-auto p-4 sm:p-6 lg:p-8">
    <Header />

    <PrinterDashboard server:defer>
      <div
        slot="fallback"
        class="p-4 bg-white rounded-xl shadow-sm border border-gray-100 flex items-center justify-center min-h-[140px]"
      >
        <div class="flex flex-col items-center gap-2 text-gray-500">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"
          >
          </div>
          <span class="text-sm">Loading Printer Status...</span>
        </div>
      </div>
    </PrinterDashboard>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      {
        showImagePrinter ? (
          <>
            <ImagePrinter client:load initialImage={initialImage} />
            <TextPrinter client:load initialText={initialText} />
          </>
        ) : (
          <>
            <TextPrinter client:load initialText={initialText} />
            <ImagePrinter client:load />
          </>
        )
      }
    </main>
  </div>
</Layout>
