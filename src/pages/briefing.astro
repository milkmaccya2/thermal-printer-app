---
import Layout from '../layouts/Layout.astro'
import { getTodaysEvents } from '../utils/googleCalendar'
import { Calendar, Clock, MapPin } from 'lucide-react'

// Get events server-side
const events = await getTodaysEvents()
const now = new Date()
const dateStr = now.toLocaleDateString('ja-JP', {
  month: 'long',
  day: 'numeric',
  weekday: 'short',
})

// We assume the weather image is available publicly at this path
// The user (via script) is responsible for updating this image before printing
const weatherImagePath = '/images/weather-today.png'
---

<Layout title="Morning Briefing">
  <!-- Container tuned for 58mm/80mm thermal printer width. 
         80mm printer safe width is ~576px. 
         We'll optimize for high contrast B&W. -->
  <div
    class="max-w-[576px] mx-auto bg-white min-h-screen p-4 font-sans text-black"
  >
    <!-- Header -->
    <header class="border-b-4 border-black pb-2 mb-6">
      <h1
        class="text-3xl font-black tracking-tighter uppercase flex items-center gap-2"
      >
        Good Morning
      </h1>
      <p class="text-lg font-bold mt-1 text-gray-700">{dateStr}</p>
    </header>

    <main class="space-y-8">
      <!-- Weather Section -->
      <section>
        <h2
          class="text-xl font-bold mb-3 border-b-2 border-gray-300 pb-1 flex items-center gap-2"
        >
          <span class="bg-black text-white px-2 py-0.5 text-sm rounded-sm"
            >WEATHER</span
          >
          Today's Forecast
        </h2>
        <div class="border-2 border-black rounded-lg overflow-hidden p-2">
          <img
            src={weatherImagePath}
            alt="Weather Forecast"
            class="w-full h-auto grayscale contrast-125"
            style="image-rendering: pixelated;"
          />
          <p class="text-xs text-right mt-1 text-gray-500">
            Source: Yahoo! Weather
          </p>
        </div>
      </section>

      <!-- Schedule Section -->
      <section>
        <h2
          class="text-xl font-bold mb-3 border-b-2 border-gray-300 pb-1 flex items-center gap-2"
        >
          <span class="bg-black text-white px-2 py-0.5 text-sm rounded-sm"
            >SCHEDULE</span
          >
          Today's Events
        </h2>

        <div class="space-y-3">
          {
            events.length === 0 ? (
              <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-500">
                <p class="font-medium">No events scheduled.</p>
                <p class="text-sm">Enjoy your day!</p>
              </div>
            ) : (
              events.map((event: any) => {
                const start = event.start.dateTime
                  ? new Date(event.start.dateTime).toLocaleTimeString('ja-JP', {
                      hour: '2-digit',
                      minute: '2-digit',
                    })
                  : 'All Day'
                // const end = event.end.dateTime ? new Date(event.end.dateTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '';

                return (
                  <div class="flex items-start gap-3 border-l-4 border-black pl-3 py-1">
                    <div class="min-w-[60px] font-mono font-bold text-lg leading-none pt-0.5">
                      {start}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-bold text-lg leading-tight mb-1">
                        {event.summary || '(No Title)'}
                      </h3>
                      {event.location && (
                        <p class="text-sm text-gray-600 flex items-center gap-1">
                          <MapPin className="w-3 h-3" />
                          {event.location}
                        </p>
                      )}
                    </div>
                  </div>
                )
              })
            )
          }
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="mt-8 pt-4 border-t-4 border-black text-center">
      <p class="text-sm font-bold uppercase tracking-widest">
        Orbital Skylab System
      </p>
    </footer>
  </div>
</Layout>

<style>
  /* Print optimizations */
  @media print {
    @page {
      margin: 0;
    }
    body {
      margin: 0;
      padding: 0;
    }
  }
</style>
